<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SmartWakacje</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Libre+Franklin:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* ============================================================
   CSS VARIABLES & RESET
   ============================================================ */
:root {
  --bg:          #141416;
  --bg-raised:   #1e1e22;
  --bg-card:     #222226;
  --bg-card-hover: #2a2a2f;
  --sand:        #e8dcc8;
  --sand-dim:    #a89b88;
  --sand-bright: #f5efe4;
  --accent:      #d4621a;
  --accent-glow: #e8782f;
  --green:       #4caf6a;
  --red:         #cf4444;
  --gold:        #d4a843;
  --blue:        #4a8ec9;

  --font-display: "DM Serif Display", Georgia, serif;
  --font-body:    "Libre Franklin", Helvetica, sans-serif;

  --radius:   12px;
  --radius-sm: 6px;
  --shadow:   0 4px 24px rgba(0,0,0,.45);
  --shadow-lg: 0 12px 48px rgba(0,0,0,.6);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html {
  font-size: 15px;
  scroll-behavior: smooth;
  -webkit-font-smoothing: antialiased;
}

body {
  font-family: var(--font-body);
  background: var(--bg);
  color: var(--sand);
  min-height: 100vh;
  overflow-x: hidden;
}

/* Grain overlay */
body::before {
  content: "";
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 9999;
  opacity: .035;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  background-size: 180px;
}

/* Ambient glow top-right */
body::after {
  content: "";
  position: fixed;
  top: -200px;
  right: -200px;
  width: 600px;
  height: 600px;
  border-radius: 50%;
  background: radial-gradient(circle, rgba(212,98,26,.08) 0%, transparent 70%);
  pointer-events: none;
  z-index: 0;
}

a { color: inherit; text-decoration: none; }

/* ============================================================
   HEADER
   ============================================================ */
.header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: linear-gradient(180deg, var(--bg) 60%, transparent);
  padding: 1.2rem 2rem .8rem;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}

.header-inner {
  max-width: 1440px;
  margin: 0 auto;
  display: flex;
  align-items: baseline;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: .8rem 2rem;
}

.logo {
  font-family: var(--font-display);
  font-size: 1.8rem;
  color: var(--sand-bright);
  letter-spacing: -.02em;
  white-space: nowrap;
}

.logo span { color: var(--accent); }

.stats-bar {
  display: flex;
  gap: 1.6rem;
  font-size: .8rem;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: .08em;
  color: var(--sand-dim);
}

.stats-bar .val {
  color: var(--sand-bright);
  font-weight: 700;
  font-size: .95rem;
  margin-left: .3rem;
}

/* ============================================================
   CONTROLS (filters + sort)
   ============================================================ */
.controls {
  max-width: 1440px;
  margin: 0 auto;
  padding: .6rem 2rem 1rem;
  display: flex;
  flex-wrap: wrap;
  gap: .6rem;
  align-items: center;
  position: relative;
  z-index: 50;
}

/* Country pills */
.pill {
  padding: .45rem 1rem;
  border-radius: 100px;
  border: 1.5px solid rgba(232,220,200,.15);
  background: transparent;
  color: var(--sand-dim);
  font-family: var(--font-body);
  font-size: .78rem;
  font-weight: 600;
  letter-spacing: .04em;
  cursor: pointer;
  transition: all .2s;
  text-transform: uppercase;
}

.pill:hover { border-color: var(--sand-dim); color: var(--sand); }

.pill.active {
  background: var(--accent);
  border-color: var(--accent);
  color: #fff;
}

/* Search input */
.search-wrap {
  position: relative;
  flex: 1;
  min-width: 180px;
  max-width: 320px;
}

.search-wrap svg {
  position: absolute;
  left: .75rem;
  top: 50%;
  transform: translateY(-50%);
  width: 16px;
  height: 16px;
  stroke: var(--sand-dim);
  fill: none;
  stroke-width: 2;
}

.search-input {
  width: 100%;
  padding: .5rem .8rem .5rem 2.3rem;
  border-radius: 100px;
  border: 1.5px solid rgba(232,220,200,.12);
  background: rgba(255,255,255,.04);
  color: var(--sand-bright);
  font-family: var(--font-body);
  font-size: .82rem;
  outline: none;
  transition: border-color .2s;
}

.search-input::placeholder { color: var(--sand-dim); opacity: .7; }
.search-input:focus { border-color: var(--accent); }

/* Divider */
.controls-divider {
  width: 1px;
  height: 24px;
  background: rgba(232,220,200,.1);
  margin: 0 .3rem;
}

/* Sort selects */
.sort-group {
  display: flex;
  align-items: center;
  gap: .4rem;
}

.sort-label {
  font-size: .7rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: .08em;
  color: var(--sand-dim);
  white-space: nowrap;
}

.sort-select {
  padding: .4rem .7rem;
  border-radius: var(--radius-sm);
  border: 1.5px solid rgba(232,220,200,.12);
  background: rgba(255,255,255,.04);
  color: var(--sand-bright);
  font-family: var(--font-body);
  font-size: .78rem;
  font-weight: 500;
  outline: none;
  cursor: pointer;
  transition: border-color .2s;
  appearance: none;
  -webkit-appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23a89b88'%3E%3Cpath d='M6 8.5L1.5 4h9z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right .5rem center;
  padding-right: 1.6rem;
}

.sort-select:focus { border-color: var(--accent); }

.sort-select option {
  background: var(--bg-raised);
  color: var(--sand);
}

.dir-btn {
  width: 30px;
  height: 30px;
  border-radius: var(--radius-sm);
  border: 1.5px solid rgba(232,220,200,.12);
  background: transparent;
  color: var(--sand-dim);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all .2s;
  font-size: .85rem;
}

.dir-btn:hover { border-color: var(--sand-dim); color: var(--sand); }
.dir-btn.desc { transform: scaleY(-1); }

/* ============================================================
   FILTER BAR
   ============================================================ */
.filter-bar {
  max-width: 1440px;
  margin: 0 auto;
  padding: 0 2rem .6rem;
  display: flex;
  flex-wrap: wrap;
  gap: .5rem;
  align-items: end;
  position: relative;
  z-index: 49;
}

.filter-group {
  display: flex;
  flex-direction: column;
  gap: .2rem;
}

.filter-label {
  font-size: .65rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: .08em;
  color: var(--sand-dim);
}

.filter-row {
  display: flex;
  align-items: center;
  gap: .25rem;
}

.filter-input {
  width: 90px;
  padding: .4rem .55rem;
  border-radius: var(--radius-sm);
  border: 1.5px solid rgba(232,220,200,.12);
  background: rgba(255,255,255,.04);
  color: var(--sand-bright);
  font-family: var(--font-body);
  font-size: .78rem;
  font-weight: 500;
  outline: none;
  transition: border-color .2s;
  -moz-appearance: textfield;
}

.filter-input::-webkit-inner-spin-button,
.filter-input::-webkit-outer-spin-button { -webkit-appearance: none; }

.filter-input::placeholder { color: var(--sand-dim); opacity: .6; }
.filter-input:focus { border-color: var(--accent); }

.filter-dash {
  color: var(--sand-dim);
  font-size: .75rem;
  padding: 0 .1rem;
}

.filter-select {
  padding: .4rem .55rem;
  border-radius: var(--radius-sm);
  border: 1.5px solid rgba(232,220,200,.12);
  background: rgba(255,255,255,.04);
  color: var(--sand-bright);
  font-family: var(--font-body);
  font-size: .78rem;
  font-weight: 500;
  outline: none;
  cursor: pointer;
  transition: border-color .2s;
  appearance: none;
  -webkit-appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23a89b88'%3E%3Cpath d='M6 8.5L1.5 4h9z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right .4rem center;
  padding-right: 1.4rem;
}

.filter-select:focus { border-color: var(--accent); }
.filter-select option { background: var(--bg-raised); color: var(--sand); }

.filter-reset {
  padding: .4rem .7rem;
  border-radius: var(--radius-sm);
  border: 1.5px solid rgba(207,68,68,.3);
  background: transparent;
  color: var(--red);
  font-family: var(--font-body);
  font-size: .7rem;
  font-weight: 600;
  cursor: pointer;
  transition: all .2s;
  align-self: end;
}

.filter-reset:hover { background: rgba(207,68,68,.12); border-color: var(--red); }

.filter-active-count {
  font-size: .7rem;
  font-weight: 600;
  color: var(--accent);
  align-self: end;
  padding-bottom: .45rem;
}

/* Google fetch-all button */
.google-fetch-all {
  padding: .4rem .75rem;
  border-radius: var(--radius-sm);
  border: 1.5px solid rgba(74,142,201,.3);
  background: rgba(74,142,201,.08);
  color: var(--blue);
  font-family: var(--font-body);
  font-size: .72rem;
  font-weight: 600;
  cursor: pointer;
  transition: all .2s;
  align-self: end;
  display: inline-flex;
  align-items: center;
  gap: .35rem;
  white-space: nowrap;
}

.google-fetch-all:hover { background: rgba(74,142,201,.15); border-color: var(--blue); }

.google-fetch-all:disabled {
  opacity: .6;
  cursor: default;
}

.google-fetch-all:disabled:hover {
  background: rgba(74,142,201,.08);
  border-color: rgba(74,142,201,.3);
}

.google-fetch-all .g-logo { font-size: 12px; }

.google-fetch-progress {
  font-size: .65rem;
  font-weight: 700;
  color: var(--sand-bright);
}

@media (max-width: 900px) {
  .filter-bar { padding: 0 1rem .5rem; }
}

@media (max-width: 500px) {
  .filter-input { width: 75px; }
}

/* ============================================================
   GRID
   ============================================================ */
.grid {
  max-width: 1440px;
  margin: 0 auto;
  padding: .5rem 2rem 4rem;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
  gap: 1.2rem;
}

/* ============================================================
   CARD
   ============================================================ */
.card {
  background: var(--bg-card);
  border-radius: var(--radius);
  overflow: hidden;
  border: 1px solid rgba(232,220,200,.06);
  transition: transform .3s cubic-bezier(.22,1,.36,1),
              box-shadow .3s cubic-bezier(.22,1,.36,1),
              border-color .3s;
  cursor: default;
  position: relative;

  /* entrance animation */
  opacity: 0;
  transform: translateY(28px);
  animation: cardIn .55s cubic-bezier(.22,1,.36,1) forwards;
}

.card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-lg);
  border-color: rgba(232,220,200,.12);
}

@keyframes cardIn {
  to { opacity: 1; transform: translateY(0); }
}

/* Photo */
.card-photo {
  position: relative;
  width: 100%;
  aspect-ratio: 16 / 10;
  overflow: hidden;
  background: var(--bg-raised);
}

.card-photo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform .5s cubic-bezier(.22,1,.36,1);
}

.card:hover .card-photo img { transform: scale(1.04); }

.card-photo::after {
  content: "";
  position: absolute;
  inset: 0;
  background: linear-gradient(0deg, rgba(20,20,22,.85) 0%, transparent 55%);
  pointer-events: none;
}

/* Badges on photo */
.photo-badges {
  position: absolute;
  top: .7rem;
  left: .7rem;
  display: flex;
  gap: .35rem;
  z-index: 2;
}

.badge {
  padding: .25rem .6rem;
  border-radius: 100px;
  font-size: .65rem;
  font-weight: 700;
  letter-spacing: .04em;
  text-transform: uppercase;
}

.badge-first { background: var(--blue); color: #fff; }
.badge-last  { background: var(--red); color: #fff; }
.badge-service {
  background: rgba(0,0,0,.55);
  color: var(--sand-bright);
  backdrop-filter: blur(6px);
  border: 1px solid rgba(255,255,255,.1);
}

/* Rating circle on photo */
.rating-circle {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 1.05rem;
  line-height: 1;
  border: 2px solid;
}

.rating-high   { background: #1a3d26; border-color: var(--green); color: var(--green); }
.rating-mid    { background: #3a2e14; border-color: var(--gold); color: var(--gold); }
.rating-low    { background: #3d1a1a; border-color: var(--red); color: var(--red); }

/* ============================================================
   GOOGLE RATING (on photo, next to wakacje rating)
   ============================================================ */
.rating-area {
  position: absolute;
  top: .7rem;
  right: .7rem;
  z-index: 2;
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: .35rem;
}

/* Google fetch button — idle state */
.google-btn {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 1.5px solid rgba(74,142,201,.35);
  background: rgba(20,20,22,.7);
  backdrop-filter: blur(6px);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all .25s;
  position: relative;
}

.google-btn:hover {
  border-color: var(--blue);
  background: rgba(74,142,201,.15);
  transform: scale(1.1);
}

.google-btn svg { width: 16px; height: 16px; }

/* Google rating circle — selected state */
.google-circle {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: rgba(16,36,56,.85);
  border: 2px solid var(--blue);
  color: var(--blue);
  font-weight: 700;
  font-size: .9rem;
  line-height: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(6px);
  cursor: pointer;
  transition: all .25s;
  text-decoration: none;
  position: relative;
}

.google-circle:hover {
  transform: scale(1.1);
  background: rgba(74,142,201,.2);
}

.google-circle small {
  font-size: .5rem;
  font-weight: 600;
  opacity: .7;
  letter-spacing: .02em;
}

/* Google "G" logo text */
.g-logo {
  font-family: "DM Serif Display", serif;
  font-size: 15px;
  font-weight: 700;
  background: linear-gradient(135deg, #4285F4, #34A853, #FBBC05, #EA4335);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

/* Loading pulse */
.google-btn.loading .g-logo {
  animation: gPulse 1s ease-in-out infinite;
}

@keyframes gPulse {
  0%, 100% { opacity: .4; }
  50% { opacity: 1; }
}

/* Not found state */
.google-btn.not-found {
  border-color: rgba(168,155,136,.2);
  cursor: default;
}

.google-btn.not-found:hover {
  background: rgba(20,20,22,.7);
  transform: none;
}

.google-btn.not-found .g-logo {
  opacity: .3;
  text-decoration: line-through;
}

/* Popover — results picker */
.google-popover {
  position: absolute;
  top: calc(100% + 6px);
  right: 0;
  width: 280px;
  background: var(--bg-raised);
  border: 1px solid rgba(74,142,201,.25);
  border-radius: var(--radius);
  box-shadow: 0 12px 40px rgba(0,0,0,.7);
  z-index: 200;
  overflow: hidden;
  animation: popIn .2s ease-out;
}

@keyframes popIn {
  from { opacity: 0; transform: translateY(-6px) scale(.96); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

.google-popover-header {
  padding: .5rem .7rem;
  font-size: .65rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: .08em;
  color: var(--sand-dim);
  border-bottom: 1px solid rgba(232,220,200,.06);
}

.google-result {
  display: flex;
  align-items: center;
  gap: .5rem;
  padding: .55rem .7rem;
  cursor: pointer;
  transition: background .15s;
  border-bottom: 1px solid rgba(232,220,200,.04);
}

.google-result:last-child { border-bottom: none; }
.google-result:hover { background: rgba(74,142,201,.08); }

.google-result-rating {
  width: 34px;
  height: 34px;
  border-radius: 50%;
  background: rgba(74,142,201,.12);
  border: 1.5px solid var(--blue);
  color: var(--blue);
  font-weight: 700;
  font-size: .8rem;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.google-result-info {
  flex: 1;
  min-width: 0;
}

.google-result-name {
  font-size: .75rem;
  font-weight: 600;
  color: var(--sand-bright);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.google-result-addr {
  font-size: .62rem;
  color: var(--sand-dim);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.google-result-count {
  font-size: .62rem;
  color: var(--sand-dim);
  flex-shrink: 0;
}

/* Tooltip for not-found */
.google-tooltip {
  position: absolute;
  bottom: calc(100% + 6px);
  right: 0;
  background: var(--bg-raised);
  border: 1px solid rgba(232,220,200,.1);
  border-radius: var(--radius-sm);
  padding: .35rem .55rem;
  font-size: .65rem;
  color: var(--sand-dim);
  white-space: nowrap;
  pointer-events: none;
  animation: popIn .15s ease-out;
}

/* Floating name on photo */
.card-photo-name {
  position: absolute;
  bottom: .6rem;
  left: .8rem;
  right: .8rem;
  z-index: 2;
}

.card-photo-name h3 {
  font-family: var(--font-display);
  font-size: 1.25rem;
  color: #fff;
  line-height: 1.2;
  text-shadow: 0 2px 8px rgba(0,0,0,.5);
}

.card-photo-name .location {
  font-size: .72rem;
  color: rgba(255,255,255,.65);
  margin-top: .15rem;
  font-weight: 500;
}

/* Stars row */
.stars {
  display: inline-flex;
  gap: 2px;
  margin-left: .4rem;
  vertical-align: middle;
  position: relative;
  top: -1px;
}

.star {
  width: 12px;
  height: 12px;
  fill: var(--gold);
}

.star-empty { fill: rgba(232,220,200,.2); }

/* Card body */
.card-body {
  padding: .8rem .9rem .9rem;
  display: flex;
  flex-direction: column;
  gap: .65rem;
}

/* Meta row: ratings */
.meta-row {
  display: flex;
  flex-wrap: wrap;
  gap: .35rem;
}

.meta-chip {
  display: inline-flex;
  align-items: center;
  gap: .3rem;
  padding: .25rem .55rem;
  border-radius: var(--radius-sm);
  background: rgba(232,220,200,.06);
  font-size: .7rem;
  font-weight: 600;
  color: var(--sand-dim);
}

.meta-chip svg {
  width: 13px;
  height: 13px;
  flex-shrink: 0;
}

.meta-chip .num { color: var(--sand-bright); }

/* Price row */
.price-row {
  display: flex;
  align-items: baseline;
  justify-content: space-between;
  padding-top: .4rem;
  border-top: 1px solid rgba(232,220,200,.06);
}

.price-main {
  font-family: var(--font-display);
  font-size: 1.5rem;
  color: var(--sand-bright);
  line-height: 1;
}

.price-main small {
  font-family: var(--font-body);
  font-size: .7rem;
  font-weight: 500;
  color: var(--sand-dim);
  margin-left: .15rem;
}

.price-per-person {
  font-size: .78rem;
  font-weight: 600;
  color: var(--accent);
}

.price-old {
  font-size: .75rem;
  color: var(--sand-dim);
  text-decoration: line-through;
  margin-left: .4rem;
}

.price-discount {
  font-size: .65rem;
  font-weight: 700;
  color: var(--green);
  margin-left: .3rem;
}

/* Footer row */
.card-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: .5rem;
}

.operator {
  font-size: .7rem;
  font-weight: 500;
  color: var(--sand-dim);
}

.dates-badge {
  font-size: .68rem;
  font-weight: 600;
  color: var(--sand-dim);
  background: rgba(232,220,200,.06);
  padding: .2rem .5rem;
  border-radius: var(--radius-sm);
}

.offer-link {
  display: inline-flex;
  align-items: center;
  gap: .3rem;
  padding: .4rem .8rem;
  border-radius: 100px;
  background: var(--accent);
  color: #fff;
  font-size: .72rem;
  font-weight: 700;
  letter-spacing: .03em;
  text-transform: uppercase;
  transition: background .2s, transform .15s;
}

.offer-link:hover {
  background: var(--accent-glow);
  transform: scale(1.04);
}

.offer-link svg {
  width: 12px;
  height: 12px;
}

/* ============================================================
   EMPTY & LOADING STATES
   ============================================================ */
.loading, .empty-state {
  text-align: center;
  padding: 6rem 2rem;
  font-family: var(--font-display);
  font-size: 1.4rem;
  color: var(--sand-dim);
}

.spinner {
  display: inline-block;
  width: 32px;
  height: 32px;
  border: 3px solid rgba(232,220,200,.15);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin .7s linear infinite;
  margin-bottom: 1rem;
}

@keyframes spin { to { transform: rotate(360deg); } }

/* ============================================================
   RESPONSIVE
   ============================================================ */
@media (max-width: 900px) {
  .grid { grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); padding: .5rem 1rem 3rem; }
  .header { padding: 1rem 1rem .6rem; }
  .controls { padding: .4rem 1rem .8rem; }
  .stats-bar { gap: .8rem; }
}

@media (max-width: 500px) {
  .grid { grid-template-columns: 1fr; }
  .header-inner { flex-direction: column; gap: .4rem; }
  .search-wrap { max-width: 100%; }
}

/* ============================================================
   SCROLLBAR
   ============================================================ */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: rgba(232,220,200,.15); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: rgba(232,220,200,.25); }

/* ============================================================
   OFFER COUNT PILL
   ============================================================ */
.offer-count {
  font-size: .75rem;
  font-weight: 600;
  color: var(--sand-dim);
  padding: .3rem 0;
  max-width: 1440px;
  margin: 0 auto;
  padding-left: 2rem;
  padding-right: 2rem;
}
.offer-count span { color: var(--sand-bright); }

/* ============================================================
   PAGINATION
   ============================================================ */
.pagination {
  max-width: 1440px;
  margin: 0 auto;
  padding: 1.5rem 2rem 3rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: .4rem;
  flex-wrap: wrap;
}

.page-btn {
  min-width: 36px;
  height: 36px;
  padding: 0 .5rem;
  border-radius: var(--radius-sm);
  border: 1.5px solid rgba(232,220,200,.1);
  background: transparent;
  color: var(--sand-dim);
  font-family: var(--font-body);
  font-size: .8rem;
  font-weight: 600;
  cursor: pointer;
  transition: all .2s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.page-btn:hover:not(:disabled) {
  border-color: var(--sand-dim);
  color: var(--sand);
}

.page-btn.active {
  background: var(--accent);
  border-color: var(--accent);
  color: #fff;
}

.page-btn:disabled {
  opacity: .3;
  cursor: default;
}

.page-ellipsis {
  color: var(--sand-dim);
  font-size: .8rem;
  padding: 0 .2rem;
}

.page-size {
  margin-left: 1rem;
  display: flex;
  align-items: center;
  gap: .35rem;
}

.page-size-label {
  font-size: .7rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: .06em;
  color: var(--sand-dim);
}

.page-size-btn {
  padding: .3rem .55rem;
  border-radius: var(--radius-sm);
  border: 1.5px solid rgba(232,220,200,.1);
  background: transparent;
  color: var(--sand-dim);
  font-family: var(--font-body);
  font-size: .75rem;
  font-weight: 600;
  cursor: pointer;
  transition: all .2s;
}

.page-size-btn:hover { border-color: var(--sand-dim); color: var(--sand); }
.page-size-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }

@media (max-width: 500px) {
  .pagination { padding: 1rem 1rem 2rem; }
  .page-size { margin-left: 0; margin-top: .5rem; }
}
</style>
</head>
<body>

<!-- HEADER -->
<header class="header">
  <div class="header-inner">
    <div class="logo">Smart<span>Wakacje</span></div>
    <div class="stats-bar" id="statsBar">
      <div>Oferty<span class="val" id="statCount">--</span></div>
      <div>Sr. cena/os<span class="val" id="statAvgPrice">--</span></div>
      <div>Sr. ocena<span class="val" id="statAvgRating">--</span></div>
      <div>Min cena/os<span class="val" id="statMinPrice">--</span></div>
    </div>
  </div>
</header>

<!-- CONTROLS -->
<div class="controls" id="controls">
  <!-- Country filters — built dynamically -->
  <button class="pill active" data-country="all">Wszystkie</button>

  <div class="controls-divider"></div>

  <!-- Search -->
  <div class="search-wrap">
    <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
    <input class="search-input" id="searchInput" type="text" placeholder="Szukaj hotelu...">
  </div>

  <div class="controls-divider"></div>

  <!-- Sort primary -->
  <div class="sort-group">
    <span class="sort-label">Sortuj</span>
    <select class="sort-select" id="sortPrimary">
      <option value="ratingValue">Ocena</option>
      <option value="pricePerPerson">Cena / os</option>
      <option value="price">Cena total</option>
      <option value="ratingRecommends">Polecenia</option>
      <option value="ratingReservationCount">Rezerwacje</option>
      <option value="employeeRatingCount">Oceny pracownikow</option>
      <option value="category">Gwiazdki</option>
      <option value="duration">Czas trwania</option>
    </select>
    <button class="dir-btn desc" id="dirPrimary" title="Kierunek sortowania">&#9650;</button>
  </div>

  <!-- Sort secondary -->
  <div class="sort-group">
    <span class="sort-label">potem</span>
    <select class="sort-select" id="sortSecondary">
      <option value="pricePerPerson">Cena / os</option>
      <option value="ratingValue">Ocena</option>
      <option value="price">Cena total</option>
      <option value="ratingRecommends">Polecenia</option>
      <option value="ratingReservationCount">Rezerwacje</option>
      <option value="employeeRatingCount">Oceny pracownikow</option>
      <option value="category">Gwiazdki</option>
      <option value="duration">Czas trwania</option>
    </select>
    <button class="dir-btn" id="dirSecondary" title="Kierunek sortowania">&#9650;</button>
  </div>
</div>

<!-- FILTER BAR -->
<div class="filter-bar" id="filterBar">
  <div class="filter-group">
    <span class="filter-label">Cena / os (zl)</span>
    <div class="filter-row">
      <input class="filter-input" id="priceMin" type="number" placeholder="od" min="0" step="100">
      <span class="filter-dash">&ndash;</span>
      <input class="filter-input" id="priceMax" type="number" placeholder="do" min="0" step="100">
    </div>
  </div>

  <div class="filter-group">
    <span class="filter-label">Cena total (zl)</span>
    <div class="filter-row">
      <input class="filter-input" id="priceTotalMin" type="number" placeholder="od" min="0" step="500">
      <span class="filter-dash">&ndash;</span>
      <input class="filter-input" id="priceTotalMax" type="number" placeholder="do" min="0" step="500">
    </div>
  </div>

  <div class="filter-group">
    <span class="filter-label">Min. ocena</span>
    <select class="filter-select" id="filterRating">
      <option value="0">Wszystkie</option>
      <option value="6">6+</option>
      <option value="7">7+</option>
      <option value="7.5">7.5+</option>
      <option value="8">8+</option>
      <option value="8.5">8.5+</option>
      <option value="9">9+</option>
    </select>
  </div>

  <div class="filter-group">
    <span class="filter-label">Min. gwiazdki</span>
    <select class="filter-select" id="filterStars">
      <option value="0">Wszystkie</option>
      <option value="3">3+</option>
      <option value="4">4+</option>
      <option value="5">5</option>
    </select>
  </div>

  <div class="filter-group">
    <span class="filter-label">Wyzywienie</span>
    <select class="filter-select" id="filterService">
      <option value="">Wszystkie</option>
    </select>
  </div>

  <button class="filter-reset" id="filterReset">Resetuj filtry</button>
  <button class="google-fetch-all" id="googleFetchAll">
    <span class="g-logo">G</span> Pobierz ratingi
    <span class="google-fetch-progress" id="googleFetchProgress"></span>
  </button>
  <span class="filter-active-count" id="filterActiveCount"></span>
</div>

<!-- Offer count -->
<div class="offer-count" id="offerCount"></div>

<!-- GRID -->
<main class="grid" id="grid">
  <div class="loading"><div class="spinner"></div><br>Ladowanie ofert...</div>
</main>

<nav class="pagination" id="pagination"></nav>

<script>
// ============================================================
// STATE
// ============================================================
let allOffers = [];
let filteredOffers = [];

const state = {
  country: "all",
  search: "",
  priceMin: 0,
  priceMax: Infinity,
  priceTotalMin: 0,
  priceTotalMax: 14000,
  minRating: 8,
  minStars: 0,
  service: "",
  page: 1,
  perPage: 20,
  sortPrimary: "ratingValue",
  sortPrimaryDir: "desc",
  sortSecondary: "pricePerPerson",
  sortSecondaryDir: "asc",
};

// ============================================================
// FETCH DATA
// ============================================================
async function loadOffers() {
  try {
    document.getElementById("priceTotalMax").value = 14000;
    document.getElementById("filterRating").value = "8";
    const res = await fetch("/api/offers");
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    allOffers = await res.json();
    buildCountryPills();
    buildServiceFilter();
    applyFilters();
    updateStats();
  } catch (err) {
    document.getElementById("grid").innerHTML =
      `<div class="empty-state">Blad ladowania: ${err.message}<br><small>Uruchom najpierw scraper: npm run fetch</small></div>`;
  }
}

// ============================================================
// COUNTRY PILLS (dynamic)
// ============================================================
function buildCountryPills() {
  const countries = [...new Set(allOffers.map((o) => o.country))].sort();
  const controlsEl = document.getElementById("controls");
  // Find the first divider
  const firstDivider = controlsEl.querySelector(".controls-divider");

  countries.forEach((c) => {
    const btn = document.createElement("button");
    btn.className = "pill";
    btn.dataset.country = c;
    btn.textContent = c;
    controlsEl.insertBefore(btn, firstDivider);
  });

  // pill click handler (delegation)
  controlsEl.addEventListener("click", (e) => {
    const pill = e.target.closest(".pill");
    if (!pill) return;
    controlsEl.querySelectorAll(".pill").forEach((p) => p.classList.remove("active"));
    pill.classList.add("active");
    state.country = pill.dataset.country;
    applyFilters();
  });
}

// ============================================================
// SERVICE FILTER (dynamic)
// ============================================================
function buildServiceFilter() {
  const services = [...new Set(allOffers.map((o) => o.serviceDesc).filter(Boolean))].sort();
  const sel = document.getElementById("filterService");
  services.forEach((s) => {
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s;
    sel.appendChild(opt);
  });
}

// ============================================================
// FILTER + SORT
// ============================================================
function applyFilters() {
  let list = allOffers;

  // Country filter
  if (state.country !== "all") {
    list = list.filter((o) => o.country === state.country);
  }

  // Search
  if (state.search) {
    const q = state.search.toLowerCase();
    list = list.filter(
      (o) =>
        o.name.toLowerCase().includes(q) ||
        o.placeName.toLowerCase().includes(q) ||
        o.tourOperator.toLowerCase().includes(q)
    );
  }

  // Price per person range
  if (state.priceMin > 0) list = list.filter((o) => o.pricePerPerson >= state.priceMin);
  if (state.priceMax < Infinity) list = list.filter((o) => o.pricePerPerson <= state.priceMax);

  // Price total range
  if (state.priceTotalMin > 0) list = list.filter((o) => o.price >= state.priceTotalMin);
  if (state.priceTotalMax < Infinity) list = list.filter((o) => o.price <= state.priceTotalMax);

  // Min rating
  if (state.minRating > 0) list = list.filter((o) => (o.ratingValue || 0) >= state.minRating);

  // Min stars
  if (state.minStars > 0) list = list.filter((o) => (o.category || 0) >= state.minStars);

  // Service type
  if (state.service) list = list.filter((o) => o.serviceDesc === state.service);

  updateActiveFilterCount();

  // Reset to page 1 when filters change (but not when just changing page)
  if (!applyFilters._keepPage) state.page = 1;
  applyFilters._keepPage = false;

  // Sort
  list = [...list].sort((a, b) => {
    const valA1 = a[state.sortPrimary] ?? 0;
    const valB1 = b[state.sortPrimary] ?? 0;
    const dir1 = state.sortPrimaryDir === "desc" ? -1 : 1;
    const cmp1 = (valA1 - valB1) * dir1;
    if (cmp1 !== 0) return cmp1;

    const valA2 = a[state.sortSecondary] ?? 0;
    const valB2 = b[state.sortSecondary] ?? 0;
    const dir2 = state.sortSecondaryDir === "desc" ? -1 : 1;
    return (valA2 - valB2) * dir2;
  });

  filteredOffers = list;
  render();
  updateOfferCount();
}

// ============================================================
// STATS
// ============================================================
function updateStats() {
  const n = allOffers.length;
  const avgPrice = n ? Math.round(allOffers.reduce((s, o) => s + o.pricePerPerson, 0) / n) : 0;
  const avgRating = n ? (allOffers.reduce((s, o) => s + (o.ratingValue || 0), 0) / n).toFixed(1) : 0;
  const minPrice = n ? Math.min(...allOffers.map((o) => o.pricePerPerson)) : 0;

  document.getElementById("statCount").textContent = ` ${n}`;
  document.getElementById("statAvgPrice").textContent = ` ${avgPrice.toLocaleString("pl")} zl`;
  document.getElementById("statAvgRating").textContent = ` ${avgRating}`;
  document.getElementById("statMinPrice").textContent = ` ${minPrice.toLocaleString("pl")} zl`;
}

function updateActiveFilterCount() {
  let count = 0;
  if (state.priceMin > 0) count++;
  if (state.priceMax < Infinity) count++;
  if (state.priceTotalMin > 0) count++;
  if (state.priceTotalMax < Infinity) count++;
  if (state.minRating > 0) count++;
  if (state.minStars > 0) count++;
  if (state.service) count++;
  const el = document.getElementById("filterActiveCount");
  el.textContent = count > 0 ? `${count} aktywn${count === 1 ? "y" : "e"} filtr${count === 1 ? "" : "y"}` : "";
}

function updateOfferCount() {
  const el = document.getElementById("offerCount");
  const total = allOffers.length;
  const filtered = filteredOffers.length;
  const start = (state.page - 1) * state.perPage + 1;
  const end = Math.min(state.page * state.perPage, filtered);
  const range = filtered > 0 ? `<span>${start}-${end}</span> z ` : "";
  el.innerHTML = filtered === total
    ? `${range}<span>${filtered}</span> ofert`
    : `${range}<span>${filtered}</span> ofert (${total} lacznie)`;
}

// ============================================================
// RENDER CARDS
// ============================================================
function render() {
  const grid = document.getElementById("grid");

  if (filteredOffers.length === 0) {
    grid.innerHTML = '<div class="empty-state">Brak ofert pasujacych do filtrow</div>';
    document.getElementById("pagination").innerHTML = "";
    return;
  }

  const totalPages = Math.ceil(filteredOffers.length / state.perPage);
  if (state.page > totalPages) state.page = totalPages;
  const start = (state.page - 1) * state.perPage;
  const pageOffers = filteredOffers.slice(start, start + state.perPage);

  const md = ["| Nazwa | Lokalizacja | Cena |", "| --- | --- | --- |"]
    .concat(pageOffers.map((o) => `| ${o.name} | ${o.country} > ${o.region} > ${o.city} | ${o.price} zł |`))
    .join("\n");
  console.log(md);

  grid.innerHTML = pageOffers
    .map((o, i) => cardHTML(o, i))
    .join("");

  renderPagination(totalPages);
}

function renderPagination(totalPages) {
  const nav = document.getElementById("pagination");
  if (totalPages <= 1) { nav.innerHTML = buildPageSizeHTML(); return; }

  let html = "";

  // Prev button
  html += `<button class="page-btn" ${state.page <= 1 ? "disabled" : ""} data-page="${state.page - 1}">&lsaquo;</button>`;

  // Page numbers with ellipsis
  const pages = buildPageNumbers(state.page, totalPages);
  for (const p of pages) {
    if (p === "...") {
      html += `<span class="page-ellipsis">&hellip;</span>`;
    } else {
      html += `<button class="page-btn ${p === state.page ? "active" : ""}" data-page="${p}">${p}</button>`;
    }
  }

  // Next button
  html += `<button class="page-btn" ${state.page >= totalPages ? "disabled" : ""} data-page="${state.page + 1}">&rsaquo;</button>`;

  // Per-page selector
  html += buildPageSizeHTML();

  nav.innerHTML = html;

  // Event delegation
  nav.onclick = (e) => {
    const btn = e.target.closest("[data-page]");
    const sizeBtn = e.target.closest("[data-size]");
    if (btn && !btn.disabled) {
      state.page = Number(btn.dataset.page);
      applyFilters._keepPage = true;
      applyFilters();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }
    if (sizeBtn) {
      state.perPage = Number(sizeBtn.dataset.size);
      state.page = 1;
      applyFilters._keepPage = true;
      applyFilters();
    }
  };
}

function buildPageNumbers(current, total) {
  if (total <= 7) return Array.from({ length: total }, (_, i) => i + 1);
  const pages = [];
  pages.push(1);
  if (current > 3) pages.push("...");
  for (let i = Math.max(2, current - 1); i <= Math.min(total - 1, current + 1); i++) {
    pages.push(i);
  }
  if (current < total - 2) pages.push("...");
  pages.push(total);
  return pages;
}

function buildPageSizeHTML() {
  return `<div class="page-size">
    <span class="page-size-label">Na strone</span>
    ${[20, 50, 100].map((n) =>
      `<button class="page-size-btn ${state.perPage === n ? "active" : ""}" data-size="${n}">${n}</button>`
    ).join("")}
  </div>`;
}

function cardHTML(o, index) {
  const delay = Math.min(index * 40, 600);
  const ratingClass = o.ratingValue >= 8 ? "rating-high" : o.ratingValue >= 6 ? "rating-mid" : "rating-low";

  const starsHTML = Array.from({ length: 5 }, (_, i) =>
    `<svg class="star ${i < o.category ? "" : "star-empty"}" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87L18.18 22 12 18.56 5.82 22 7 14.14l-5-4.87 6.91-1.01z"/></svg>`
  ).join("");

  const promoBadges = [
    o.promoFirstMinute ? '<span class="badge badge-first">First Minute</span>' : "",
    o.promoLastMinute ? '<span class="badge badge-last">Last Minute</span>' : "",
  ].filter(Boolean).join("");

  const serviceHTML = o.serviceDesc
    ? `<span class="badge badge-service">${esc(o.serviceDesc)}</span>`
    : "";

  const oldPriceHTML = o.priceOld
    ? `<span class="price-old">${o.priceOld.toLocaleString("pl")} zl</span>`
    : "";

  const discountHTML = o.priceDiscount
    ? `<span class="price-discount">-${o.priceDiscount}%</span>`
    : "";

  const photoURL = o.photo || `https://placehold.co/570x428/1e1e22/a89b88?text=${encodeURIComponent(o.name.slice(0, 12))}`;

  const departDate = formatDate(o.departureDate);
  const returnDate = formatDate(o.returnDate);

  return `
  <article class="card" style="animation-delay: ${delay}ms">
    <div class="card-photo">
      <img src="${esc(photoURL)}" alt="${esc(o.name)}" loading="lazy" onerror="imgFallback(this)">
      <div class="photo-badges">
        ${promoBadges}
        ${serviceHTML}
      </div>
      <div class="rating-area">
        ${o.ratingValue ? `<div class="rating-circle ${ratingClass}">${o.ratingValue.toFixed(1)}</div>` : ""}
        ${googleRatingHTML(o)}
      </div>
      <div class="card-photo-name">
        <h3>${esc(o.name)} ${starsHTML}</h3>
        <div class="location">${esc(o.country)} / ${esc(o.region)} / ${esc(o.city)}</div>
      </div>
    </div>

    <div class="card-body">
      <div class="meta-row">
        ${metaChip("thumb", o.ratingRecommends, "polecen")}
        ${metaChip("calendar", o.ratingReservationCount, "rezerwacji")}
        ${metaChip("briefcase", o.employeeRatingCount, "ocen prac.")}
        ${metaChip("clock", o.duration, "dni")}
      </div>

      <div class="price-row">
        <div>
          <span class="price-main">${o.price.toLocaleString("pl")}<small> zl</small></span>
          ${oldPriceHTML}${discountHTML}
        </div>
        <span class="price-per-person">${o.pricePerPerson.toLocaleString("pl")} zl / os</span>
      </div>

      <div class="card-footer">
        <span class="operator">${esc(o.tourOperator)}</span>
        <span class="dates-badge">${departDate} - ${returnDate}</span>
        <a class="offer-link" href="${esc(o.url)}" target="_blank" rel="noopener">
          Zobacz
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M7 17L17 7M17 7H7M17 7v10"/></svg>
        </a>
      </div>
    </div>
  </article>`;
}

// ============================================================
// GOOGLE RATING
// ============================================================
const GOOGLE_ICON = '<span class="g-logo">G</span>';

function googleRatingHTML(o) {
  // Already has a selected google rating (from cache/previous selection)
  if (o.googleRating > 0 && o.googleMapsUrl) {
    return `<a class="google-circle" href="${esc(o.googleMapsUrl)}" target="_blank" rel="noopener" title="Google Maps: ${o.googleRating} (${o.googleRatingsTotal} opinii)">
      ${o.googleRating.toFixed(1)}
      <small>${abbreviateCount(o.googleRatingsTotal)}</small>
    </a>`;
  }
  if (o.googleRating === 0 && o.googleMapsUrl === null && o.googleRatingsTotal === 0) {
    // Was fetched but not found
    return `<div class="google-btn not-found" title="Nie znaleziono w Google Maps">${GOOGLE_ICON}</div>`;
  }
  // Not yet fetched — show fetch button
  return `<button class="google-btn" onclick="fetchGoogleRating(this, '${esc(o.name).replace(/'/g, "\\'")}', '${esc(o.city || "").replace(/'/g, "\\'")}', '${esc(o.country || "").replace(/'/g, "\\'")}')" title="Pobierz rating z Google Maps">${GOOGLE_ICON}</button>`;
}

function abbreviateCount(n) {
  if (n >= 1000) return (n / 1000).toFixed(1) + "k";
  return String(n);
}

async function fetchGoogleRating(btn, name, city, country) {
  if (btn.classList.contains("loading") || btn.classList.contains("not-found")) return;
  btn.classList.add("loading");

  try {
    const params = new URLSearchParams({ name, city, country });
    const res = await fetch(`/api/google-rating?${params}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    if (!data.results || data.results.length === 0) {
      // Not found — update local offer + show state
      const offer = allOffers.find((o) => o.name === name);
      if (offer) { offer.googleRating = 0; offer.googleRatingsTotal = 0; offer.googleMapsUrl = null; }
      btn.classList.remove("loading");
      btn.classList.add("not-found");
      btn.onclick = null;
      btn.title = "Nie znaleziono w Google Maps";
      return;
    }

    if (data.selected != null) {
      // Auto-selected (single result or previously selected)
      const r = data.results[data.selected];
      applyGoogleSelection(btn, name, r);
      return;
    }

    // Multiple results — show popover
    showGooglePopover(btn, name, data.results);
  } catch (err) {
    btn.classList.remove("loading");
    btn.title = `Blad: ${err.message}`;
    console.error("Google rating fetch error:", err);
  }
}

function showGooglePopover(btn, hotelName, results) {
  btn.classList.remove("loading");
  closeAllPopovers();

  const popover = document.createElement("div");
  popover.className = "google-popover";
  popover.innerHTML = `
    <div class="google-popover-header">Wybierz hotel (${results.length} wynikow)</div>
    ${results.map((r, i) => `
      <div class="google-result" data-index="${i}">
        <div class="google-result-rating">${r.rating ? r.rating.toFixed(1) : "-"}</div>
        <div class="google-result-info">
          <div class="google-result-name" title="${esc(r.name)}">${esc(r.name)}</div>
          <div class="google-result-addr" title="${esc(r.address)}">${esc(r.address)}</div>
        </div>
        <div class="google-result-count">${abbreviateCount(r.totalRatings)}</div>
      </div>
    `).join("")}
  `;

  // Position relative to btn's parent (.rating-area)
  btn.parentElement.appendChild(popover);

  popover.addEventListener("click", async (e) => {
    const row = e.target.closest(".google-result");
    if (!row) return;
    const idx = Number(row.dataset.index);

    // Save selection via API
    try {
      await fetch("/api/google-rating/select", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ hotelName, selectedIndex: idx }),
      });
    } catch (err) {
      console.error("Select save error:", err);
    }

    const r = results[idx];
    popover.remove();
    applyGoogleSelection(btn, hotelName, r);
  });

  // Close on outside click
  setTimeout(() => {
    document.addEventListener("click", function handler(e) {
      if (!popover.contains(e.target) && e.target !== btn) {
        popover.remove();
        document.removeEventListener("click", handler);
      }
    });
  }, 10);
}

function applyGoogleSelection(btn, hotelName, result) {
  // Update local offer objects (may be multiple offers with same hotel name)
  for (const o of allOffers) {
    if (o.name === hotelName) {
      o.googleRating = result.rating;
      o.googleRatingsTotal = result.totalRatings;
      o.googleMapsUrl = result.mapsUrl;
    }
  }

  // Replace button with rating circle
  const circle = document.createElement("a");
  circle.className = "google-circle";
  circle.href = result.mapsUrl || "#";
  circle.target = "_blank";
  circle.rel = "noopener";
  circle.title = `Google Maps: ${result.rating} (${result.totalRatings} opinii)`;
  circle.innerHTML = `${result.rating ? result.rating.toFixed(1) : "0"}<small>${abbreviateCount(result.totalRatings)}</small>`;
  btn.replaceWith(circle);
}

function closeAllPopovers() {
  document.querySelectorAll(".google-popover").forEach((p) => p.remove());
}

// ── Batch fetch all visible offers ──────────────────────────
let batchRunning = false;

async function fetchAllGoogleRatings() {
  if (batchRunning) return;
  batchRunning = true;

  const btn = document.getElementById("googleFetchAll");
  const progress = document.getElementById("googleFetchProgress");
  btn.disabled = true;

  // Only offers visible on current page, deduplicated by name
  const start = (state.page - 1) * state.perPage;
  const pageOffers = filteredOffers.slice(start, start + state.perPage);
  const seen = new Set();
  const toFetch = [];
  for (const o of pageOffers) {
    if (seen.has(o.name)) continue;
    seen.add(o.name);
    if (o.googleRating > 0 || (o.googleRating === 0 && o.googleMapsUrl === null && o.googleRatingsTotal === 0)) continue;
    toFetch.push(o);
  }

  if (toFetch.length === 0) {
    progress.textContent = "gotowe!";
    setTimeout(() => { progress.textContent = ""; btn.disabled = false; batchRunning = false; }, 2000);
    return;
  }

  let done = 0;
  let found = 0;

  for (const o of toFetch) {
    done++;
    progress.textContent = `${done}/${toFetch.length}`;

    try {
      const params = new URLSearchParams({ name: o.name, city: o.city || "", country: o.country || "" });
      const res = await fetch(`/api/google-rating?${params}`);
      if (!res.ok) continue;
      const data = await res.json();

      if (data.results?.length > 0 && data.selected != null) {
        const r = data.results[data.selected];
        for (const offer of allOffers) {
          if (offer.name === o.name) {
            offer.googleRating = r.rating;
            offer.googleRatingsTotal = r.totalRatings;
            offer.googleMapsUrl = r.mapsUrl;
          }
        }
        found++;
      } else if (!data.results?.length) {
        for (const offer of allOffers) {
          if (offer.name === o.name) {
            offer.googleRating = 0;
            offer.googleRatingsTotal = 0;
            offer.googleMapsUrl = null;
          }
        }
      }
      // Multi-result without selection — skip (user will pick manually)
    } catch { /* continue */ }

    // Re-render every 5 fetches to show progress in cards
    if (done % 5 === 0) render();
  }

  render();
  progress.textContent = `${found}/${toFetch.length}`;
  setTimeout(() => { progress.textContent = ""; }, 5000);
  btn.disabled = false;
  batchRunning = false;
}

document.getElementById("googleFetchAll").addEventListener("click", fetchAllGoogleRatings);

// ============================================================
// ICONS for meta chips
// ============================================================
const ICONS = {
  thumb: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 9V5a3 3 0 00-3-3l-4 9v11h11.28a2 2 0 002-1.7l1.38-9a2 2 0 00-2-2.3H14zM7 22H4a2 2 0 01-2-2v-7a2 2 0 012-2h3"/></svg>',
  calendar: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>',
  briefcase: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2"/></svg>',
  clock: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>',
};

function metaChip(icon, value, label) {
  return `<span class="meta-chip">${ICONS[icon]}<span class="num">${value ?? "-"}</span> ${label}</span>`;
}

// ============================================================
// HELPERS
// ============================================================
function esc(s) {
  if (!s) return "";
  return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
}

function formatDate(d) {
  if (!d) return "";
  const [y, m, day] = d.split("-");
  return `${day}.${m}`;
}

function imgFallback(img) {
  img.onerror = null;
  const name = img.alt || "Hotel";
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="570" height="428">
    <rect width="100%" height="100%" fill="#1e1e22"/>
    <text x="50%" y="45%" fill="#a89b88" font-size="16" text-anchor="middle" font-family="sans-serif">${name.slice(0, 25)}</text>
    <text x="50%" y="55%" fill="#555" font-size="12" text-anchor="middle" font-family="sans-serif">brak zdjecia</text>
  </svg>`;
  img.src = "data:image/svg+xml," + encodeURIComponent(svg);
}

// ============================================================
// EVENT BINDINGS
// ============================================================
document.getElementById("searchInput").addEventListener("input", (e) => {
  state.search = e.target.value.trim();
  applyFilters();
});

document.getElementById("sortPrimary").addEventListener("change", (e) => {
  state.sortPrimary = e.target.value;
  applyFilters();
});

document.getElementById("sortSecondary").addEventListener("change", (e) => {
  state.sortSecondary = e.target.value;
  applyFilters();
});

document.getElementById("dirPrimary").addEventListener("click", (e) => {
  state.sortPrimaryDir = state.sortPrimaryDir === "desc" ? "asc" : "desc";
  e.currentTarget.classList.toggle("desc", state.sortPrimaryDir === "desc");
  applyFilters();
});

document.getElementById("dirSecondary").addEventListener("click", (e) => {
  state.sortSecondaryDir = state.sortSecondaryDir === "desc" ? "asc" : "desc";
  e.currentTarget.classList.toggle("desc", state.sortSecondaryDir === "desc");
  applyFilters();
});

// Filter inputs — debounced for price fields
let filterTimer;
function onFilterInput() {
  clearTimeout(filterTimer);
  filterTimer = setTimeout(() => {
    state.priceMin = Number(document.getElementById("priceMin").value) || 0;
    state.priceMax = Number(document.getElementById("priceMax").value) || Infinity;
    state.priceTotalMin = Number(document.getElementById("priceTotalMin").value) || 0;
    state.priceTotalMax = Number(document.getElementById("priceTotalMax").value) || Infinity;
    applyFilters();
  }, 300);
}

document.getElementById("priceMin").addEventListener("input", onFilterInput);
document.getElementById("priceMax").addEventListener("input", onFilterInput);
document.getElementById("priceTotalMin").addEventListener("input", onFilterInput);
document.getElementById("priceTotalMax").addEventListener("input", onFilterInput);

document.getElementById("filterRating").addEventListener("change", (e) => {
  state.minRating = Number(e.target.value);
  applyFilters();
});

document.getElementById("filterStars").addEventListener("change", (e) => {
  state.minStars = Number(e.target.value);
  applyFilters();
});

document.getElementById("filterService").addEventListener("change", (e) => {
  state.service = e.target.value;
  applyFilters();
});

document.getElementById("filterReset").addEventListener("click", () => {
  state.priceMin = 0;
  state.priceMax = Infinity;
  state.priceTotalMin = 0;
  state.priceTotalMax = Infinity;
  state.minRating = 0;
  state.minStars = 0;
  state.service = "";
  document.getElementById("priceMin").value = "";
  document.getElementById("priceMax").value = "";
  document.getElementById("priceTotalMin").value = "";
  document.getElementById("priceTotalMax").value = "";
  document.getElementById("filterRating").value = "0";
  document.getElementById("filterStars").value = "0";
  document.getElementById("filterService").value = "";
  applyFilters();
});

// ============================================================
// INIT
// ============================================================
loadOffers();
</script>
</body>
</html>
